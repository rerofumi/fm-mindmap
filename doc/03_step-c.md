# 開発ステップC: データ永続化と仕上げ

## 1. 目標
作成したマインドマップをファイルとして保存・読み込み可能にし、アプリを完成させる。このステップが完了すると、ユーザーは作成したマインドマップを保存・共有し、後で続きの作業を行えるようになる。

---

## 2. 関連仕様

### 2.1. 前提
- ステップA、Bで実装された全ての機能が完成していること。
- ノードオブジェクトの全プロパティが実装されていること:
    - `id`: 一意の識別子 (string)
    - `title`: ノードのタイトル (string)
    - `question`: LLMへの質問テキスト (string)
    - `answer`: LLMからの回答テキスト (string)
    - `memo`: プライベートメモ (string)
    - `color`: ノードの色 (string, hexコード)
    - `isRoot`: ルートノードかどうかのフラグ (boolean)
    - `parentId`: 親ノードのID (string | null)
    - `position`: キャンバス上の座標 (object: {x, y})

### 2.2. データ永続化
- **保存・読み込み**:
    - 現在のマインドマップの状態（全ノードのデータ）を、独自のMarkdownでローカルファイルにエクスポート・インポートできる。
    - markdown の先頭には mermaid 形式で Mindmap が表現されており簡易プレビューに使える
      - mermaid形式の Mindmap では Title と階層構造しか表現できないためその他の情報は欠落する、あくまでプレビュー用
- **Markdownフォーマット案**:
    ```markdown
    # MindMap Export

    ```mermaid
    Maindmap
    ```

    ---
    ## Node
    - title: `ルートノード`
    - question: `これは何？`
    - answer: `これはルートノードです。`
    - memo: `気になる所`
    - color: `#aabbcc`
    - isRoot: `true`
    - parentTitle: `null`
    - position: `{ "x": 100, "y": 50 }`
    ---
    ## Node
    - title: `子ノード`
    - ...
    ---
    ```

### 2.3. UIコンポーネント
- **ヘッダーの拡張**:
    - 「保存」ボタン: 現在のマインドマップをファイルとしてダウンロードする。
    - 「読み込み」ボタン: ファイルセレクターを開き、マインドマップファイルを読み込む。

---

## 3. タスク一覧

1.  **データシリアライゼーション機能の実装**
    - `src/lib/serializer.ts` を作成し、現在のマインドマップの状態（ノード配列）をMarkdown形式の文字列に変換する関数を実装する。
    - ノードのプロパティを上記のMarkdownフォーマットに従って出力する。
    - JSONフォーマットのオプションも提供し、より簡潔な保存形式として利用できるようにする。
2.  **データデシリアライゼーション機能の実装**
    - `src/lib/deserializer.ts` を作成し、Markdown/JSON形式の文字列からノード配列を復元する関数を実装する。
    - 各ノードのプロパティを正しく解析し、Zustandストアに適用できる形式に変換する。
    - 不正なフォーマットや欠損データに対するエラーハンドリングを実装する。
3.  **ファイル保存機能の実装**
    - `src/lib/fileUtils.ts` を作成し、Blobを使ってファイルをブラウザからダウンロードする関数を実装する。
    - ヘッダーに「保存」ボタンを追加し、クリック時にシリアライゼーション→ダウンロードの処理を実行する。
    - ファイル名は現在の日時を含めて自動生成する（例: `mindmap_2024-12-28_14-30.md`）。
4.  **ファイル読み込み機能の実装**
    - ヘッダーに「読み込み」ボタンを追加し、HTML `<input type="file">` 要素を非表示で配置する。
    - ボタンクリック時にファイルセレクターを開き、選択されたファイルを読み込む。
    - ファイル内容をデシリアライゼーション関数で解析し、Zustandストアの状態を更新する。
    - 現在のマインドマップが上書きされることを警告するダイアログを表示する。
5.  **UI/UX改善とエラーハンドリング**
    - ローディング表示: LLMリクエスト中やファイル読み込み中にスピナーを表示する。
    - 通知システム: 保存成功、読み込み成功、エラー発生時の通知を実装する（例: `react-hot-toast`）。
    - バリデーション: アップロードされたファイルの形式チェックと、不正なデータに対するエラーメッセージ。
    - 操作の取り消し確認: ノード削除やファイル読み込み時の確認ダイアログ。
6.  **全体のリファクタリングとテスト**
    - コードの整理とTypeScriptの型安全性の向上。
    - 主要な機能の動作確認テスト。
    - UI/UXの最終調整とパフォーマンス最適化。
7.  **ドキュメント化**
    - `README.md` を作成し、アプリの使い方やセットアップ方法を記載する。
    - 開発者向けのコードドキュメントを整備する。
