# マインドマップアプリ仕様書 v2

本文書は、`01_claim.md` に記載された要求に基づき、マインドマップアプリ開発のための詳細仕様、タスク一覧、および開発ステップを定義したものです。  
現在の実装状況（2025年11月15日時点）を反映し、02_specifications.md から大幅に機能強化を行った版です。

---

## 1. 詳細仕様

### 1.1. コア機能

- **マインドマップ描画エンジン**:
  - Webベースのインタラクティブなグラフ描画ライブラリ（React Flow）を利用する。
  - ノードとエッジ（連結線）をキャンバス上にレンダリングする。
  - ノードのドラッグ＆ドロップによる移動、キャンバスのドラッグによるスクロール（パン）、およびズームに対応する。
- **データ構造**:
  - アプリケーションの状態はZustandで一元管理する。
  - **ノードオブジェクト** (`MindMapNodeData`):
    - `title`: ノードのタイトル (string)
    - `color`: ノードの色 (string, hexコード)
    - `isRoot`: ルートノードかどうかのフラグ (boolean)
    - `question`: LLMへの質問テキスト (string)
    - `answer`: LLMからの回答テキスト (string)
    - `memo`: プライベートメモ (string)
  - **ノード** (`MindMapNode`):
    - `id`: 一意の識別子 (string, nanoidで生成)
    - `type`: ノードタイプ ('root' | 'normal')
    - `position`: キャンバス上の座標 (object: {x, y})
    - `data`: MindMapNodeData
  - **エッジ** (`MindMapEdge`):
    - `id`: エッジの識別子 (string, 'e-{source}-{target}'形式)
    - `source`: 親ノードのID (string)
    - `target`: 子ノードのID (string)
    - `style`: エッジのスタイル (object: {stroke, strokeWidth})
- **UIコンポーネント**:
  - **ヘッダー** (`Header.tsx`): アプリ全体の操作を行うボタンを配置。
  - **マインドマップキャンバス** (`MindMapCanvas.tsx`): マインドマップを描画するメインエリア。
  - **詳細情報サイドバー** (`Sidebar.tsx`): 選択されたノードの詳細情報を表示・編集するためのフォーム。
  - **チャットサイドバー** (`ChatSidebar.tsx`): 選択ノードのチャット履歴を表示し、リアルタイムでLLMと対話可能。
  - **サマライズモーダル** (`SummarizeModal.tsx`): サマライズ結果をMarkdown形式で表示する。
  - **カスタムノード**:
    - **ルートノード** (`RootNode.tsx`): 角丸四角形で表示。ノード自体を直接クリックして編集可能。
    - **通常ノード** (`NormalNode.tsx`): 四角形で表示。ノード自体を直接クリックして編集可能。
  - **色選択ピッカー**: サイドバーに配置し、直感的な色変更を可能にする（HTML5カラーインプット）。

### 1.2. ノード操作

- **作成**:
  - ヘッダーの「ルートノード作成」ボタンで、`isRoot: true` のノードをキャンバスに追加する。
    - デフォルトタイトル: 'Root Node'、色: '#ff6b6b'
    - 重複時は 'Root Node (2)', 'Root Node (3)'... と自動採番
  - ヘッダーの「新規ノード作成」ボタンで、現在選択中のノードの子ノードを作成する。親が選択されていない場合は何もしない。
    - デフォルトタイトル: 'New Node'、色: 親ノードの色を継承
    - 重複時は 'New Node (2)', 'New Node (3)'... と自動採番
  - **連想ノード生成**: サイドバーの「Create Associated Nodes」ボタンで、選択ノードのタイトルから連想される関連性の高い4つの子ノードを自動生成する（しりとり形式、日本語）。
- **編集**:
  - サイドバーのフォームを通じて、ノードのタイトル、LLMへの質問、色、メモを編集・更新できる。
  - **ノード内直接編集**: ノード自体をダブルクリックして、タイトルを直接編集できる（Enterで確定、Escapeでキャンセル）。
  - **タイトル自動生成**: サイドバーの「Summarize to Title」ボタンで、質問と回答からLLMが自動的に適切なタイトル（10-15文字程度）を生成する。
- **削除**:
  - ヘッダーの「ノード削除」ボタンで、選択中のノード（およびその全子孫ノード）を削除する。
  - 再帰的に子孫を検索して一括削除する。
- **親子関係変更**:
  - ドラッグ＆ドロップ操作でノードを別のノードの上に重ねることで、親を変更できる。
  - 循環参照を自動検出し、警告メッセージで防止する。
- **レイアウト**:
  - **ノード整列**: ヘッダーの「Align Nodes」ボタンで、木構造に基づいてノードを自動的に整列配置する。
    - 水平間隔: 250px、垂直間隔: 100px
    - サブツリーの高さを計算し、バランスよく配置
  - **色適用**: サイドバーの「Apply Color to Children」ボタンで、選択ノードの色を全ての子孫ノードに適用する（幅優先探索）。

### 1.3. LLM連携

- **APIクライアント** (`lib/api.ts`):
  - OpenRouter のAPIと通信を行うクライアントモジュールを実装する。
  - APIキーと使用モデルは `.env` ファイルに定義し、アプリケーションから読み込む。
    - `VITE_OPENROUTER_API_KEY`: OpenRouter APIキー
    - `VITE_OPENROUTER_MODEL`: 使用モデル（デフォルト: openai/gpt-3.5-turbo）
  - `fetchLLMResponse(messages: ChatMessage[]): Promise<string>` 関数でAPI呼び出しを行う。
- **コンテキスト構築** (`getContext`):
  - LLMに質問を送信する際、選択中のノードから親をたどり、ルートノードまでの経路に含まれる全ノードの「質問」と「回答」を収集する。
  - 収集したQ&Aを `ChatMessage[]` 型 (`[{role: 'user', content: '...'}, {role: 'assistant', content: '...'}]`) の形式に整形し、APIリクエストの会話履歴（コンテキスト）として使用する。
  - `getContext(nodeId, includeCurrentNode?)` でコンテキストを取得可能。
- **実行と表示**:
  - サイドバーの「Execute」ボタンで、構築したコンテキストと共に「質問」をAPIに送信する。
  - APIからのレスポンスを「回答」としてノードデータに保存し、サイドバーに表示する。
  - ローディング中はボタンにスピナーアイコンを表示。
- **チャット機能** (`chatAndCreateNode`):
  - チャットサイドバーで、選択ノードのチャット履歴をリアルタイムで表示する。
  - 質問を入力して送信すると、以下の処理を自動実行:
    1. ユーザーメッセージをチャット履歴に追加
    2. コンテキストを構築してLLMに送信
    3. LLM回答をチャット履歴に追加
    4. 新しい子ノードを自動生成（質問・回答を含む）
    5. 質問と回答からタイトルを自動生成（LLMによる要約）
    6. 新しいノードを選択状態にする
  - **メッセージ改良機能**: ChatSidebar内で、送信前にLLMがユーザーの入力を校正・明確化する。
- **サマライズ**:
  - サイドバーの「Summarize」ボタンで、現在のコンテキスト（会話履歴）の要約をLLMにリクエストする。
  - 結果をMarkdown形式でモーダルダイアログに表示する（react-markdown + remark-gfm使用）。

### 1.4. データ永続化

- **保存・読み込み** (`lib/fileUtils.ts`):
  - 現在のマインドマップの状態（全ノードのデータ）を、Markdown + JSON形式でローカルファイルにエクスポート・インポートできる。
  - エクスポートファイルには、Mermaid図によるプレビューと、JSONデータが含まれる。
  - **エクスポート** (`exportToMarkdown`):
    - ファイル名: `mindmap_YYYYMMDD_HHMMSS.md`
    - ブラウザのダウンロード機能を使用してファイルをダウンロード
  - **インポート** (`importFromMarkdown`):
    - ファイル選択ダイアログから.mdファイルを読み込み
    - Markdownから```json...```ブロックを抽出してパース
    - 確認ダイアログで既存データの上書きを確認
- **Markdownフォーマット**:
  ```markdown
  # MindMap Export

  ## Preview
  ```mermaid
  graph TD
    node_1["ルートノード"]
    node_2["子ノード"]
    node_1 --> node_2
  ```

  ---
  ## Data
  ```json
  {
    "nodes": [...],
    "edges": [...]
  }
  ```
  ```

---

## 2. タスク分解

1. **環境構築 & プロジェクトセットアップ** ✅
   - `Vite` + `React` + `TypeScript` でプロジェクトを作成。
   - `ESLint`, `Prettier` でコードフォーマットを統一。
   - UIフレームワーク（Radix UI/shadcn）、状態管理（`Zustand`）、マインドマップ描画（`React Flow`）を導入。
   - `.env` ファイルで環境変数を管理する設定。
2. **UIコンポーネント実装** ✅
   - `Header.tsx`: 各種操作ボタンを持つコンポーネント。
   - `MindMapCanvas.tsx`: `React Flow` をラップし、カスタムノードとエッジを描画する。
   - `Sidebar.tsx`: 選択ノード情報を表示・編集するフォームを持つコンポーネント。
   - `ChatSidebar.tsx`: チャット履歴表示とリアルタイム対話用のコンポーネント。
   - `RootNode.tsx`, `NormalNode.tsx`: 表示スタイルの異なるカスタムノードコンポーネント（直接編集対応）。
   - `SummarizeModal.tsx`: サマライズ結果をMarkdownで表示するモーダル。
3. **マインドマップ基本機能実装** ✅
   - `Zustand` ストアを設計し、ノードのCRUD（作成、読み取り、更新、削除）ロジックを実装。
   - ボタン操作によるノードの追加・削除機能。
   - ノード選択とサイドバーの連携。
   - サイドバーでのタイトル・色・メモ情報の更新機能。
   - ノードのドラッグ移動、キャンバスのパン・ズーム機能の実装。
   - **ノード内直接編集機能**: ノードを直接クリックしてタイトルを編集可能。
4. **親子関係編集機能実装** ✅
   - `React Flow` のイベントハンドラを利用し、ノードのドラッグ＆ドロップによる親の付け替えロジックを実装。
   - **循環参照検出**: 親子関係変更時に循環参照を検出し、警告を表示して防止する。
5. **LLM連携機能実装** ✅
   - `api.ts`: API通信を行うクライアントを実装。
   - サイドバーに質問・回答のテキストエリアと実行ボタンを実装。
   - コンテキスト構築ロジックを実装。
   - APIリクエストと、結果の取得・表示機能を実装。
   - サマライズ機能とモーダル表示を実装。
   - **チャット機能**: チャットサイドバーでリアルタイム対話と自動子ノード生成。
   - **メッセージ改良機能**: LLMによる入力テキストの自動校正。
6. **データ永続化機能実装** ✅
   - マインドマップの状態をMarkdown/JSONに変換するシリアライザーを実装。
   - テキストから状態を復元するデシリアライザーを実装。
   - ファイルのダウンロード・アップロード機能を実装。
7. **高度な機能実装** ✅
   - **ノード整列機能**: 木構造に基づいてノードを自動配置。
   - **連想ノード生成**: LLMを使って関連性の高い子ノードを自動生成。
   - **色適用機能**: 選択ノードの色を全ての子孫ノードに一括適用。
   - **タイトル自動生成**: 質問と回答からLLMが適切なタイトルを自動生成。
8. **リファインメント** ✅
   - UI/UXの改善（ローディング表示、通知など）。
   - APIエラーやノード名重複などのエラーハンドリングを実装。
   - 全体の動作テストとデバッグ。

---

## 3. 実装済み新機能（v2で追加）

### 3.1. チャット機能（ChatSidebar）
- 選択ノードのチャット履歴をリアルタイムで表示
- 質問入力とLLM回答の対話型インターフェース
- 回答から自動的に新しい子ノードを生成（質問・回答・タイトルを自動設定）
- メッセージの自動改良機能（校正・明確化）
- チャットサイドバーの開閉トグル機能
- `chatAndCreateNode` 関数による一連の処理の自動化

### 3.2. ノード内直接編集
- ノードをダブルクリックしてタイトルを直接編集
- Enterキーで確定、Escapeキーでキャンセル
- 重複チェックと自動インデックス付与（括弧形式: ` (2)`, ` (3)`...）
- カスタムノードコンポーネント（RootNode, NormalNode）で実装

### 3.3. 高度なノード操作
- **ノード整列** (`alignNodes`): 木構造に基づいてノードを自動配置
  - サブツリーの高さを計算してバランスよく配置
  - 水平・垂直間隔は定数で管理
- **連想ノード生成** (`addMultipleChildNodes`): LLMを使って関連性の高い4つの子ノードを自動生成
  - しりとり形式で日本語の連想語を生成
  - カンマ区切りで取得し、自動的にパース
- **色適用機能** (`applyColorToDescendants`): 選択ノードの色を全ての子孫ノードに一括適用
  - 幅優先探索で全子孫を検出
  - ノードとエッジの両方の色を更新
- **タイトル自動生成**: 質問と回答からLLMが適切なタイトル（10-15文字）を自動生成
  - Sidebarの「Summarize to Title」ボタン
  - チャット機能での子ノード生成時にも自動実行

### 3.4. メモ機能
- 各ノードにプライベートなメモを追加・編集可能（`memo`フィールド）
- サイドバーのTextareaからアクセス可能
- NotebookPenアイコンで視覚的に表示

### 3.5. 循環参照検出
- 親子関係変更時（ドラッグ＆ドロップ）に循環参照を自動検出
- 警告メッセージ（toast通知）を表示して不正な接続を防止
- MindMapCanvas内の`onNodeDrop`ハンドラで実装

### 3.6. データ永続化の強化
- Markdown + JSON形式でのエクスポート（タイムスタンプ付きファイル名）
- Mermaid図によるプレビュー表示
- ファイル読み込み時の確認ダイアログ（既存データ上書き確認）
- `exportToMarkdown` / `importFromMarkdown` 関数で実装

---

## 4. 技術スタック

### 4.1. フロントエンド
- **フレームワーク**: React 18.3.1 + TypeScript
- **ビルドツール**: Vite 6.3.4
- **スタイリング**: Tailwind CSS + shadcn/ui (Radix UI)
- **グラフ描画**: React Flow 11.11.4
- **状態管理**: Zustand 5.0.6
- **フォーム**: React Hook Form + Zod
- **Markdown**: React Markdown + remark-gfm
- **アイコン**: Lucide React

### 4.2. LLM連携
- **API**: OpenRouter (https://openrouter.ai/api/v1/chat/completions)
- **モデル**: OpenAI GPT-3.5-turbo (デフォルト: openai/gpt-3.5-turbo)
- **環境変数**:
  - `VITE_OPENROUTER_API_KEY`: OpenRouter APIキー（必須）
  - `VITE_OPENROUTER_MODEL`: 使用するLLMモデル（オプション）
- **エラーハンドリング**: API通信エラー時はtoast通知でユーザーに通知

### 4.3. 開発ツール
- **Lint**: ESLint 9.9.0
- **パッケージマネージャー**: pnpm 10.9.0

---

## 5. ファイル構成

```
src/
├── components/
│   ├── ui/              # shadcn/ui コンポーネント（各種UIプリミティブ）
│   ├── ChatSidebar.tsx  # チャット機能用サイドバー
│   ├── Header.tsx       # ヘッダー（ルートノード作成、子ノード作成、削除、整列、保存/読込）
│   ├── MindMapCanvas.tsx # マインドマップキャンバス（React Flow統合、D&D、循環参照検出）
│   ├── Sidebar.tsx      # ノード編集用サイドバー（タイトル、色、質問、回答、メモ、各種ボタン）
│   ├── SummarizeModal.tsx # サマライズモーダル（Markdown表示）
│   ├── made-with-dyad.tsx # Dyadウォーターマーク
│   └── customNodes/     # カスタムノード
│       ├── RootNode.tsx  # ルートノード（角丸、直接編集可能）
│       └── NormalNode.tsx # 通常ノード（四角形、直接編集可能）
├── lib/
│   ├── api.ts          # LLM APIクライアント（fetchLLMResponse関数）
│   ├── fileUtils.ts    # ファイル入出力（exportToMarkdown, importFromMarkdown）
│   ├── store.ts        # Zustand ストア（状態管理、全ロジック）
│   └── utils.ts        # ユーティリティ（cn関数など）
├── types/
│   └── index.ts        # 型定義（MindMapNode, MindMapNodeData, MindMapEdge, ChatMessage）
├── hooks/
│   ├── use-mobile.tsx  # モバイル判定
│   └── use-toast.ts    # トースト通知フック
├── pages/
│   ├── Index.tsx       # メインページ
│   └── NotFound.tsx    # 404ページ
├── utils/
│   └── toast.ts        # トースト通知ヘルパー（showSuccess, showError）
├── App.tsx             # ルートコンポーネント（ルーティング）
├── main.tsx            # エントリーポイント
├── globals.css         # グローバルスタイル
└── vite-env.d.ts       # Vite型定義
```

