# マインドマップアプリ仕様書

本文書は `01_claim.md` に記載された要求に基づき、マインドマップアプリ開発のための詳細仕様、タスク一覧、および開発ステップを定義するものです。

---

## 1. 詳細仕様

### 1.1. コア機能

- **マインドマップ描画エンジン**:
    - Webベースのインタラクティブなグラフ描画ライブラリ（例: React Flow）を利用する。
    - ノードとエッジ（連結線）をキャンバス上にレンダリングする。
    - ノードのドラッグ＆ドロップによる移動、キャンバスのドラッグによるスクロール（パン）、およびズームに対応する。
- **データ構造**:
    - アプリケーションの状態は状態管理ライブラリ（例: Zustand）で一元管理する。
    - **ノードオブジェクト**:
        - `id`: 一意の識別子 (string)
        - `title`: ノードのタイトル (string)
        - `question`: LLMへの質問テキスト (string)
        - `answer`: LLMからの回答テキスト (string)
        - `color`: ノードの色 (string, hexコード)
        - `isRoot`: ルートノードかどうかのフラグ (boolean)
        - `parentId`: 親ノードのID (string | null)
        - `position`: キャンバス上の座標 (object: {x, y})
- **UIコンポーネント**:
    - **ヘッダー**: アプリ全体の操作を行うボタンを配置。
    - **マインドマップキャンバス**: マインドマップを描画するメインエリア。
    - **詳細情報サイドバー**: 選択されたノードの詳細情報を表示・編集するためのフォーム。開閉可能とする。
    - **カスタムノード**:
        - **ルートノード**: 角丸四角形で表示。
        - **通常ノード**: 四角形で表示。
    - **色選択ピッカー**: サイドバーに配置し、直感的な色変更を可能にする。
    - **サマライズモーダル**: サマライズ結果をMarkdown形式で表示する。

### 1.2. ノード操作

- **作成**:
    - ヘッダーの「ルートノード作成」ボタンで、`isRoot: true` のノードをキャンバスに追加する。
    - ヘッダーの「新規ノード作成」ボタンで、現在選択中のノードの子ノードを作成する。親が選択されていない場合は何もしない。
    - ノード名（タイトル）の重複チェックを行い、重複する場合は末尾にインデックス（例: `_1`, `_2`）を自動付与する。
- **編集**:
    - サイドバーのフォームを通じて、ノードのタイトル、LLMへの質問、色を編集・更新できる。
- **削除**:
    - ヘッダーの「ノード削除」ボタンで、選択中のノード（およびその全子孫ノード）を削除する。
- **親子関係変更**:
    - ドラッグ＆ドロップ操作でノードを別のノードの上に重ねることで、親を変更できるようにする。

### 1.3. LLM連携

- **APIクライアント**:
    - [OpenRouter](https://openrouter.ai/) のAPIと通信を行うクライアントモジュールを実装する。
    - APIキーと使用モデルは `.env` ファイルに定義し、アプリケーションから読み込む。
- **コンテキスト構築**:
    - LLMに質問を送信する際、選択中のノードから親をたどり、ルートノードまでの経路に含まれる全ノードの「質問」と「回答」を収集する。
    - 収集したQ&Aを `[{role: 'user', content: '...'}, {role: 'assistant', content: '...'}]` の形式に整形し、APIリクエストの会話履歴（コンテキスト）として使用する。
- **実行と表示**:
    - サイドバーの「実行」ボタンで、構築したコンテキストと共に「質問」をAPIに送信する。
    - APIからのレスポンスを「回答」としてノードデータに保存し、サイドバーに表示する。
- **サマライズ**:
    - サイドバーの「サマライズ」ボタンで、現在のコンテキスト（会話履歴）の要約をLLMにリクエストする。
    - 結果をMarkdown形式でモーダルダイアログに表示する。

### 1.4. データ永続化

- **保存・読み込み**:
    - 現在のマインドマップの状態（全ノードのデータ）を、独自のMarkdownまたはJSON形式でローカルファイルにエクスポート・インポートできる。
- **Markdownフォーマット案**:
    ```markdown
    # MindMap Export

    ---
    ## Node
    - id: `node_1`
    - title: `ルートノード`
    - question: `これは何？`
    - answer: `これはルートノードです。`
    - color: `#aabbcc`
    - isRoot: `true`
    - parentId: `null`
    - position: `{ "x": 100, "y": 50 }`
    ---
    ## Node
    - id: `node_2`
    - title: `子ノード`
    - ...
    ---
    ```

---

## 2. タスク分解

1.  **環境構築 & プロジェクトセットアップ**
    - `Vite` + `React` + `TypeScript` でプロジェクトを作成。
    - `ESLint`, `Prettier` でコードフォーマットを統一。
    - UIフレームワーク（例: `MUI`）、状態管理（`Zustand`）、マインドマップ描画（`React Flow`）を導入。
    - `.env` ファイルで環境変数を管理する設定。
2.  **UIコンポーネント実装**
    - `Header.tsx`: 各種操作ボタンを持つコンポーネント。
    - `MindMapCanvas.tsx`: `React Flow` をラップし、カスタムノードとエッジを描画する。
    - `Sidebar.tsx`: 選択ノード情報を表示・編集するフォームを持つコンポーネント。
    - `RootNode.tsx`, `NormalNode.tsx`: 表示スタイルの異なるカスタムノードコンポーネント。
3.  **マインドマップ基本機能実装**
    - `Zustand` ストアを設計し、ノードのCRUD（作成、読み取り、更新、削除）ロジックを実装。
    - ボタン操作によるノードの追加・削除機能。
    - ノード選択とサイドバーの連携。
    - サイドバーでのタイトル・色情報の更新機能。
    - ノードのドラッグ移動、キャンバスのパン・ズーム機能の実装。
4.  **親子関係編集機能実装**
    - `React Flow` のイベントハンドラを利用し、ノードのドラッグ＆ドロップによる親の付け替えロジックを実装。
5.  **LLM連携機能実装**
    - `OpenRouterAPI.ts`: API通信を行うクライアントを実装。
    - サイドバーに質問・回答のテキストエリアと実行ボタンを実装。
    - コンテキスト構築ロジックを実装。
    - APIリクエストと、結果の取得・表示機能を実装。
    - サマライズ機能とモーダル表示を実装。
6.  **データ永続化機能実装**
    - マインドマップの状態をテキスト（Markdown/JSON）に変換するシリアライザーを実装。
    - テキストから状態を復元するデシリアライザーを実装。
    - ファイルのダウンロード・アップロード機能を実装。
7.  **リファインメント**
    - UI/UXの改善（ローディング表示、通知など）。
    - APIエラーやノード名重複などのエラーハンドリングを実装。
    - 全体の動作テストとデバッグ。

---

## 3. 開発ステップ (3段階)

### ステップ1: マインドマップの基本構造と表示 (MVP)

- **目標**: マインドマップの視覚的な作成と編集ができるコア機能を提供する。
- **タスク**:
    1.  環境構築とプロジェクトセットアップを完了させる。
    2.  UIの骨格（ヘッダー、キャンバス、サイドバー）を実装する。
    3.  カスタムノード（Root, Normal）とエッジを表示する。
    4.  状態管理を導入し、ノードの追加・削除・タイトル編集を可能にする。
    5.  ノードのドラッグ移動とキャンバスのパン・ズームを実装する。
    6.  ノードと線の色変更機能を実装する。
    7.  ドラッグ＆ドロップによる親の付け替えを実装する。

### ステップ2: LLM連携とチャット機能の実装

- **目標**: 各ノードに紐づくLLMチャット機能を完成させ、アプリの核となる価値を提供する。
- **タスク**:
    1.  サイドバーにLLM用の質問・回答フォームを実装する。
    2.  OpenRouter APIクライアントを実装し、`.env` でキーを管理できるようにする。
    3.  選択ノードからルートまでのコンテキストを構築するロジックを実装する。
    4.  APIを実行し、結果を回答欄に表示する機能を実装する。
    5.  コンテキストのサマライズ機能を実装する。

### ステップ3: データ永続化と仕上げ

- **目標**: 作成したマインドマップをファイルとして保存・読み込み可能にし、アプリを完成させる。
- **タスク**:
    1.  マインドマップデータを指定のフォーマットに変換するシリアライズ/デシリアライズロジックを実装する。
    2.  ファイルの保存（ダウンロード）と読み込み（アップロード）機能を実装する。
    3.  全体的なUI/UXの調整と、エラーハンドリングを強化する。
    4.  最終的な動作確認とリファクタリングを行う。

